name: Pre-commit Automerge

on:
  workflow_dispatch:
  pull_request_target:
    types:
      - labeled
      - synchronize
      - opened
      - reopened

permissions:
  pull-requests: write
  contents: write
  issues: write

jobs:
  automerge:
    runs-on: ubuntu-latest
    steps:
      - name: Check required labels
        id: label-check
        run: |
          echo "dependencies=false" >> "$GITHUB_OUTPUT"
          echo "chore=false" >> "$GITHUB_OUTPUT"
          labels=$(jq -r '.pull_request.labels[].name' <<< "{% raw %}${{ toJson(github.event.pull_request) }}{% endraw %}")
          if grep -q 'dependencies' <<< "$labels"; then echo "dependencies=true" >> "$GITHUB_OUTPUT"; fi
          if grep -q 'chore' <<< "$labels"; then echo "chore=true" >> "$GITHUB_OUTPUT"; fi

      - name: Enable auto-merge
        if: |
          {% raw %}github.event.pull_request.head.ref == 'chore/pre-commit-update'{% endraw %} &&
          steps.label-check.outputs.dependencies == 'true' &&
          steps.label-check.outputs.chore == 'true'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: {% raw %}${{ secrets.GITHUB_TOKEN }}{% endraw %}
          merge-method: squash
          pull-request-number: {% raw %}${{ github.event.pull_request.number }}{% endraw %}

      - name: Comment on PR if labels are missing
        if: |
          {% raw %}github.event.pull_request.head.ref == 'chore/pre-commit-update'{% endraw %} &&
          (steps.label-check.outputs.dependencies != 'true' || steps.label-check.outputs.chore != 'true')
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: {% raw %}${{ secrets.GITHUB_TOKEN }}{% endraw %}
          issue-number: {% raw %}${{ github.event.pull_request.number }}{% endraw %}
          body: |
            ⚠️ Auto-merge not enabled because this PR is missing one or both required labels: `dependencies`, `chore`.
            Please add the labels to enable auto-merge.
